import sys
import math
import getopt
import cosmocalcs
import lensingClassFile
import numpy 
import matplotlib.pyplot as plt
from numpy import roll
from numpy import linspace
from numpy import logspace
import powerspec

def main(argv):
    print ''
    print '=== Running nonlinearPS.py program ====\n'

    print argv

    #try:
    #opts, args = getopt.getopt(argv,"ho:")
    #except getopt.GetoptError as err: # if include option that's not there
    #    print "Program parameter not found\n"

    i = int(argv[3])
    j = int(argv[5])
    shearBins = int(argv[1])      

    """for opt, arg in opts:
        if opt == '-i':
            i = arg
        elif opt == '-j':
            j = arg
        elif opt in ("-n"):
            shearBins = arg
        elif opt in ("-h"):
            print "Run program with: python nonlinearPS.py -n <number of shear bins> -i <first bin to calculate cross-spectra spectrum> -j <second bin to calculate cross-spectra spectrum>"

    if i == '' or j == '' or shearBins == '':
	print "i, j, or shearBins not found\n"""

    print "Number of bins is: ", shearBins, " i is: ", i, " j is: ", j

    print "Initializing lc class\n"

    lc = lensingClassFile.lensingClass(0)

    print "Extracting redshifts from DLS data"

    F2redshifts = lc.getRedshiftsFromDLS()    	
    organizedList, numberedList = lc.organizeRedshifts(F2redshifts)
    sortedF2Redshifts = lc.sort_Redshift_Values(organizedList)

    ns = 0.96  # spectral index
    DelRsq = 2.1e-9  # amplitude of primordial curvature fluctuations at the pivot scale

    #larray = linspace(0, 1000, 50)
    larray = logspace(math.log10(1), math.log10(1e7), 500)

    pKij = []

    #Warraytt = [0.054663251, 0.054394183, 0.053922034, 0.053220422, 0.052279643, 0.051103333, 0.04970533, 0.048106844, 0.046334018, 0.044415877, 0.042382656, 0.040264482, 0.038090358, 0.035887434, 0.033680498, 0.031491665, 0.029340217, 0.027242572, 0.025212346, 0.023260486, 0.02139545, 0.01962342, 0.01794854, 0.016373152, 0.014898037, 0.013522643, 0.012245307, 0.011063458, 0.009973796, 0.008972467, 0.008055204, 0.007217456, 0.006454504, 0.005761548, 0.005133794, 0.004566508, 0.004055079, 0.003595051, 0.003182159, 0.003182148, 0.002812338, 0.00248178, 0.002186881, 0.001924287, 0.001690881, 0.001483781, 0.001300332, 0.0011381, 0.000994857, 0.000868577, 0.000757415, 0.000659704, 0.000573938, 0.000498759, 0.000432948, 0.000375413, 0.000325176, 0.000281367, 0.000243209, 0.000210011, 0.000181163, 0.000156122, 0.00013441, 0.000115604, 9.93E-05, 8.53E-05, 7.31E-05, 6.27E-05, 5.36E-05, 4.59E-05, 3.92E-05, 3.34E-05, 2.85E-05, 2.43E-05, 2.06E-05, 1.75E-05, 1.49E-05, 1.26E-05, 1.07E-05, 9.00E-06, 7.58E-06, 6.38E-06, 5.35E-06, 4.48E-06, 3.74E-06, 3.10E-06, 2.57E-06, 2.11E-06, 1.73E-06, 1.40E-06, 1.13E-06, 8.91E-07, 6.93E-07, 5.26E-07, 3.85E-07, 2.65E-07, 1.65E-07, 7.98E-08]

    Warraytt = [0.000295913, 0.000586919, 0.000873113, 0.001154586, 0.001431429, 0.001703731, 0.001971577, 0.002235053, 0.002494239, 0.002749218, 0.003000067, 0.003246863, 0.003489682, 0.003728597, 0.00396368 , 0.004195002, 0.00442263 , 0.004646634, 0.004867077, 0.005084025, 0.00529754 , 0.005507685, 0.005714519, 0.005918101, 0.00611849 , 0.006315742, 0.006509911, 0.006701053, 0.00688922 , 0.007074464, 0.007256836, 0.007436386, 0.007613163, 0.007787214, 0.007958585, 0.008127324, 0.008293475, 0.008457081, 0.008618186, 0.008776832, 0.00893306 , 0.009086911, 0.009238425, 0.00938764 , 0.009534595, 0.009679328, 0.009821874, 0.00996227 , 0.01010055 , 0.010236751, 0.010370905, 0.010503046, 0.010633206, 0.010761417, 0.010887712, 0.011012119, 0.011134671, 0.011255395, 0.011297328, 0.011336169, 0.011320878, 0.011302105, 0.011263476, 0.011221468, 0.01128943 , 0.011355324, 0.011281618, 0.011204851, 0.011239451, 0.01127189 , 0.011222967, 0.011171445, 0.011153462, 0.011133194, 0.011068391, 0.011001304, 0.010974857, 0.010946383, 0.010893488, 0.010838622, 0.010821445, 0.010802531, 0.010521606, 0.010241236, 0.010228996, 0.010215309, 0.010121096, 0.01002551 , 0.009998197, 0.009969566, 0.009902282, 0.00983375 , 0.009793138, 0.009751346, 0.009632994, 0.009513819, 0.009488328, 0.009461824, 0.009355087, 0.009247622, 0.00921389 , 0.009179259, 0.009107452, 0.009034869, 0.008973586, 0.008911551, 0.008788149, 0.008664474, 0.008486313, 0.008308749, 0.008182768, 0.008056744, 0.007995036, 0.007932822, 0.007835249, 0.007737464, 0.007644989, 0.007552314, 0.007474435, 0.007396288, 0.007323546, 0.00725054 , 0.007152876, 0.007055216, 0.006971444, 0.006887586, 0.006779605, 0.006671861, 0.006576421, 0.006481116, 0.006378491, 0.006276146, 0.006201256, 0.006126367, 0.006033466, 0.00594081 , 0.005859068, 0.005777477, 0.005692764, 0.005608277, 0.005544388, 0.005480526, 0.005384742, 0.005289421, 0.005243807, 0.005198119, 0.005144367, 0.005090621, 0.004984144, 0.004878443, 0.004819717, 0.004761095, 0.004700546, 0.004640142, 0.00455368 , 0.004467762, 0.004397494, 0.004327552, 0.00428386 , 0.004240206, 0.004190718, 0.004141339, 0.004087442, 0.004033719, 0.003950818, 0.003868571, 0.003775992, 0.003684328, 0.00362064 , 0.003557345, 0.00348318 , 0.003409631, 0.003315543, 0.003222593, 0.003191034, 0.003159528, 0.003083295, 0.003007851, 0.002965414, 0.002923176, 0.002878324, 0.002833719, 0.002774175, 0.002715156, 0.002666271, 0.002617737, 0.002558639, 0.002500121, 0.002447523, 0.002395399, 0.002337989, 0.002281191, 0.002235339, 0.002189882, 0.002145247, 0.002101005, 0.002052047, 0.0020036  , 0.001956929, 0.001910748, 0.001881382, 0.001852197, 0.001818893, 0.001785845, 0.001761792, 0.001737864, 0.001695539, 0.001653689, 0.001619578, 0.001585783, 0.001566919, 0.001548139, 0.001533879, 0.00151966 , 0.001489864, 0.001460332, 0.001438673, 0.00141715 , 0.001398229, 0.001379412, 0.001368522, 0.001357655, 0.001328641, 0.001299915, 0.001280768, 0.001261743, 0.001250906, 0.001240099, 0.001230419, 0.001220761, 0.001208863, 0.001197008, 0.001173141, 0.001149498, 0.001136786, 0.001124132, 0.001113348, 0.001102603, 0.001083036, 0.001063631, 0.001052727, 0.001041867, 0.001031317, 0.00102081 , 0.001006012, 0.000991312, 0.000977496, 0.000963767, 0.000942578, 0.000921614, 0.000892897, 0.000864625, 0.000855391, 0.0008462  , 0.000833638, 0.000821162, 0.000804399, 0.000787802, 0.000772356, 0.000757057, 0.000743332, 0.000729727, 0.000718761, 0.000707872, 0.000694623, 0.000681494, 0.000670852, 0.00066029 , 0.000652153, 0.000644062, 0.000629262, 0.000614631, 0.000604252, 0.000593958, 0.000587217, 0.000580511, 0.000567682, 0.000554994, 0.000542925, 0.000530987, 0.000516329, 0.000501874, 0.000494393, 0.000486965, 0.000480762, 0.000474597, 0.000442757, 0.000412025, 0.000406379, 0.000400771, 0.000395803, 0.000390864, 0.00038935 , 0.000387837, 0.000381691, 0.000375593, 0.000373359, 0.000371131, 0.000357618, 0.000344357, 0.000312869, 0.000282895, 0.000279936, 0.000276991, 0.000274962, 0.000272939, 0.000258394, 0.000244248, 0.000240369, 0.00023652 , 0.000235917, 0.000235314, 0.000217926, 0.000201208, 0.000197201, 0.000193234, 0.000184118, 0.000175224, 0.000174591, 0.00017396 , 0.000173201, 0.000172443, 0.000172183, 0.000171922, 0.000161934, 0.000152247, 0.00015177 , 0.000151293, 0.00015066 , 0.000150028, 0.000145723, 0.000141481, 0.000136192, 0.000131004, 0.000130346, 0.000129689, 0.000125469, 0.00012132 , 0.000118105, 0.000114934, 0.000113366, 0.000111809, 0.000107553, 0.000103382, 0.000102964, 0.000102548, 9.88062E-05, 9.51351E-05, 9.46362E-05, 9.41385E-05, 8.96393E-05, 8.52516E-05, 7.53495E-05, 6.60615E-05, 6.21952E-05, 5.84468E-05, 5.63407E-05, 5.42738E-05, 5.27104E-05, 5.11703E-05, 4.44793E-05, .82591E-05, 3.78342E-05, 3.74116E-05, 3.19856E-05, 2.69862E-05, 2.68388E-05, 2.66919E-05, 2.57949E-05, 2.49134E-05, 2.06624E-05, 1.68101E-05, 1.63942E-05, 1.59837E-05, 1.59004E-05, 1.58173E-05, 1.57043E-05, 1.55917E-05, 1.55533E-05, 1.5515E-05 , 1.54548E-05, 1.53947E-05, 1.48568E-05, 1.43287E-05, 1.4294E-05 , 1.42593E-05, 1.38513E-05, 1.34494E-05, 1.26638E-05, 1.19021E-05, 1.17943E-05, 1.16871E-05, 1.1153E-05 , 1.06315E-05, 9.76296E-06, 8.93174E-06, 8.88413E-06, 8.83665E-06, 7.82712E-06, 6.87919E-06, 6.56632E-06, 6.26086E-06, 6.2467E-06 , 6.23256E-06, 6.22597E-06, 6.21937E-06, 6.04572E-06, 5.8746E-06 , 5.86582E-06, 5.85703E-06, 5.84581E-06, 5.8346E-06 , 5.82704E-06, 5.81948E-06, 5.81555E-06, 5.81162E-06, 5.80406E-06, 5.79649E-06, 5.78651E-06, 5.77653E-06, 5.76776E-06, 5.759E-06  , 5.75264E-06, 5.74629E-06, 5.73393E-06, 5.72158E-06, 5.71283E-06, 5.70409E-06, 5.70014E-06, 5.69618E-06, 5.68505E-06, 5.67394E-06, 5.66878E-06, 5.66363E-06, 5.63589E-06, 5.60822E-06, 5.57708E-06, 5.54604E-06, 5.54095E-06, 5.53585E-06, 5.53076E-06, 5.52566E-06, 5.51938E-06, 5.51311E-06, 5.48695E-06, 5.46086E-06, 5.43949E-06, 5.41816E-06, 5.36336E-06, 5.30885E-06, 5.11623E-06, 4.92725E-06, 4.92144E-06, 4.91562E-06, 4.9043E-06 , 4.89298E-06, 4.85205E-06, 4.81131E-06, 4.58578E-06, 4.36578E-06, 4.29425E-06, 4.22335E-06, 4.21403E-06, 4.20472E-06, 4.17613E-06, 4.14764E-06, 4.13337E-06, 4.11913E-06, 4.11497E-06, 4.11081E-06, 4.10063E-06, 4.09047E-06, 4.04238E-06, 3.99459E-06, 3.97076E-06, 3.947E-06  , 3.94394E-06, 3.94088E-06, 3.93291E-06, 3.92495E-06, 3.89746E-06, 3.87007E-06, 3.86705E-06, 3.86402E-06, 3.861E-06  , 3.85797E-06, 3.84914E-06, 3.84031E-06, 3.83439E-06, 3.82848E-06, 3.82643E-06, 3.82438E-06, 3.81655E-06, 3.80873E-06, 3.80188E-06, 3.79504E-06, 3.79204E-06, 3.78904E-06, 3.78699E-06, 3.78495E-06, 3.7829E-06 , 3.78085E-06, 3.7788E-06 , 3.77676E-06, 3.77375E-06, 3.77075E-06, 3.76775E-06, 3.76474E-06, 3.76269E-06, 3.76064E-06, 3.75859E-06, 3.75654E-06, 3.75449E-06, 3.75243E-06, 3.75038E-06, 3.74833E-06, 3.74532E-06, 3.74232E-06, 3.74027E-06, 3.73821E-06, 3.73616E-06, 3.7341E-06 , 3.73205E-06, 3.72999E-06, 3.72794E-06, 3.72588E-06, 3.72382E-06, 3.72177E-06, 3.71971E-06, 3.71765E-06, 3.71559E-06, 3.71354E-06, 3.71148E-06, 3.70942E-06, 3.70736E-06, 3.7053E-06 , 3.70325E-06, 3.70119E-06, 3.69913E-06, 3.69707E-06, 3.69501E-06, 3.69296E-06, 3.6909E-06 , 3.68884E-06, 3.68678E-06, 3.68472E-06, 3.68267E-06, 3.68061E-06, 3.67855E-06, 3.6765E-06 , 3.67444E-06, 3.67238E-06, 3.67033E-06, 3.66827E-06, 3.66621E-06, 3.66416E-06, 3.6621E-06 , 3.66005E-06, 3.65799E-06, 3.65594E-06, 3.65388E-06, 3.65183E-06, 3.64978E-06, 3.64772E-06, 3.64567E-06, 3.64362E-06, 3.64157E-06, 3.63952E-06, 3.63746E-06, 3.63541E-06, 3.63336E-06, 3.63132E-06, 3.62927E-06, 3.62722E-06, 3.62425E-06, 3.62129E-06, 3.61924E-06, 3.6172E-06 , 3.61515E-06, 3.61311E-06, 3.61107E-06, 3.60902E-06, 3.60607E-06, 3.60312E-06, 3.60016E-06, 3.59721E-06, 3.59154E-06, 3.58587E-06, 3.58202E-06, 3.57817E-06, 3.57614E-06, 3.57412E-06, 3.57209E-06, 3.57006E-06, 3.56532E-06, 3.56059E-06, 3.55857E-06, 3.55655E-06, 3.55363E-06, 3.55071E-06, 3.5289E-06 , 3.50717E-06, 3.5016E-06 , 3.49603E-06, 3.49405E-06, 3.49206E-06, 3.47671E-06, 3.4614E-06 , 3.45766E-06, 3.45392E-06, 3.45018E-06, 3.44645E-06, 3.43388E-06, 3.42135E-06, 3.41764E-06, 3.41393E-06, 3.39267E-06, 3.37149E-06, 3.3687E-06 , 3.36591E-06, 3.35702E-06, 3.34814E-06, 3.33321E-06, 3.31832E-06, 3.31383E-06, 3.30935E-06, 3.30229E-06, 3.29524E-06, 3.28906E-06, 3.28289E-06, 3.269E-06  , 3.25516E-06, 3.24135E-06, 3.22757E-06, 3.21978E-06, 3.21201E-06, 3.1907E-06 , 3.16948E-06, 3.16599E-06, 3.1625E-06 , 3.15398E-06, 3.14547E-06, 3.11025E-06, 3.07525E-06, 3.06936E-06, 3.06348E-06, 3.03948E-06, 3.01558E-06, 2.99179E-06, 2.96811E-06, 2.95749E-06, 2.9469E-06 , 2.89771E-06, 2.84895E-06, 2.82829E-06, 2.80771E-06, 2.7637E-06 , 2.72006E-06, 2.70534E-06, 2.69067E-06, 2.6676E-06 , 2.64463E-06, 2.58539E-06, 2.52685E-06, 2.50902E-06, 2.49127E-06, 2.44121E-06, 2.39169E-06, 2.3744E-06 , 2.35718E-06, 2.34506E-06, 2.33298E-06, 2.2494E-06 , 2.16739E-06, 2.14896E-06, 2.13062E-06, 2.09066E-06, 2.0511E-06 , 2.0279E-06 , 2.00484E-06, 1.98851E-06, 1.97225E-06, 1.92354E-06, 1.87546E-06, 1.83687E-06, 1.7987E-06 , 1.76095E-06, 1.72362E-06, 1.70129E-06, 1.67911E-06, 1.65469E-06, 1.63046E-06, 1.61115E-06, 1.59197E-06, 1.5537E-06 , 1.51591E-06, 1.44654E-06, 1.37883E-06, 1.36443E-06, 1.35012E-06, 1.33159E-06, 1.31321E-06, 1.27233E-06, 1.23211E-06, 1.20885E-06, 1.18582E-06, 1.16904E-06, 1.15239E-06, 1.12256E-06, 1.09313E-06, 1.07322E-06, 1.05351E-06, 1.02693E-06, 1.0007E-06 , 9.82621E-07, 9.64713E-07, 9.45629E-07, 9.26746E-07, 9.01027E-07, 8.75684E-07, 8.51996E-07, 8.28645E-07, 8.11031E-07, 7.93617E-07, 7.69905E-07, 7.46566E-07, 7.35027E-07, 7.23584E-07, 6.9483E-07 , 6.66676E-07, 6.50964E-07, 6.35449E-07, 6.00695E-07, 5.66938E-07, 5.5902E-07 , 5.51163E-07, 5.39979E-07, 5.28916E-07, 5.19298E-07, 5.09773E-07, 4.81664E-07, 4.54367E-07, 4.3482E-07 , 4.15713E-07, 4.06356E-07, 3.97112E-07, 3.84272E-07, 3.7165E-07 , 3.69209E-07, 3.66777E-07, 3.49027E-07, 3.31727E-07, 3.27073E-07, 3.22454E-07, 3.20456E-07, 3.18466E-07, 3.16483E-07, 3.14508E-07, 2.9689E-07 , 2.7979E-07 , 2.76741E-07, 2.7371E-07 , 2.69511E-07, 2.65346E-07, 2.63086E-07, 2.60837E-07, 2.59528E-07, 2.58223E-07, 2.45043E-07, 2.32215E-07, 2.25328E-07, 2.1855E-07 , 2.18002E-07, 2.17456E-07, 2.15006E-07, 2.12572E-07, 2.06209E-07, 1.99945E-07, 1.89997E-07, 1.80308E-07, 1.79244E-07, 1.78184E-07, 1.74841E-07, 1.71532E-07, 1.69936E-07, 1.68349E-07, 1.64553E-07, 1.60803E-07, 1.44941E-07, 1.2991E-07 , 1.29186E-07, 1.28464E-07, 1.26613E-07, 1.24777E-07, 1.23115E-07, 1.21464E-07, 1.20296E-07, 1.19134E-07, 1.08991E-07, 9.93049E-08, 9.79726E-08, 9.665E-08  , 9.61759E-08, 9.57032E-08, 9.52319E-08, 9.4762E-08 , 8.72259E-08, 8.00059E-08, 7.88182E-08, 7.76399E-08, 7.49828E-08, 7.23733E-08, 6.80374E-08, 6.38378E-08, 6.34619E-08, 6.30874E-08, 5.97083E-08, 5.64241E-08, 5.48024E-08, 5.32052E-08, 4.94099E-08, 4.57569E-08, 4.52527E-08, 4.47515E-08, 3.79759E-08, 3.17594E-08, 3.0554E-08 , 2.93726E-08, 2.79895E-08, 2.66405E-08, 2.63342E-08, 2.60297E-08, 2.57992E-08, 2.55697E-08, 2.30437E-08, 2.06503E-08, 2.01914E-08, 1.97379E-08, 1.97271E-08, 1.97164E-08, 1.95178E-08, 1.93203E-08, 1.81481E-08, 1.70132E-08, 1.70039E-08, 1.69947E-08, .66382E-08, 1.62857E-08, 1.48308E-08, 1.34447E-08, 1.32827E-08, 1.31219E-08, 1.30129E-08, 1.29044E-08, 1.2496E-08 , 1.20943E-08, 1.14599E-08, 1.0843E-08 , 1.0561E-08 , 1.02829E-08, 1.02773E-08, 1.02718E-08, 1.00423E-08, 9.81557E-09, 9.63509E-09, 9.45637E-09, 9.40815E-09, 9.36008E-09, 9.2694E-09, 9.17921E-09, 9.04728E-09, 8.91637E-09, 8.33546E-09, 7.77441E-09, 7.46099E-09, 7.15418E-09, 7.15033E-09, 7.14648E-09, 7.10529E-09, 7.06424E-09, 6.87586E-09, 6.69013E-09, 6.50704E-09, 6.32659E-09, 5.90868E-09, 5.50525E-09, 5.27543E-09, 5.05062E-09, 4.64855E-09, 4.26335E-09, 4.14669E-09, 4.0317E-09, 3.97377E-09, 3.91629E-09, 3.72362E-09, 3.53591E-09, 3.48186E-09, 3.42825E-09, 3.34957E-09, 3.27184E-09, 3.19507E-09, 3.11925E-09, 2.76024E-09, 2.42335E-09, 2.29404E-09, 2.16835E-09, 2.1672E-09, 2.16604E-09, 1.96547E-09, 1.77475E-09, 1.70066E-09, 1.6282E-09, 1.62734E-09, 1.62647E-09, 1.43705E-09, 1.25945E-09, 1.16727E-09, 1.07863E-09, 9.9354E-10, 9.11987E-10, 8.59429E-10, 8.08458E-10, 7.83359E-10, 7.58669E-10, 7.2259E-10, 6.87409E-10, 5.98493E-10, 5.15776E-10, 4.86192E-10, .57497E-10, 4.47972E-10, 4.38552E-10, 4.20248E-10, 4.02343E-10, 3.93437E-10, 3.84635E-10, 3.42904E-10, 3.0359E-10, 2.95892E-10, 2.88297E-10, 2.88145E-10, 2.87994E-10, 2.8051E-10, 2.73128E-10, 2.45006E-10, 2.18424E-10, 2.11936E-10, 2.05549E-10, 1.99264E-10, 1.93078E-10, 1.7531E-10, 1.58408E-10, 1.47594E-10, 1.37168E-10, 1.22287E-10, 1.08267E-10, 1.0821E-10, 1.08154E-10, 1.0364E-10, 9.92253E-11, 8.26759E-11, 6.76428E-11, 6.76076E-11, 6.75724E-11, 6.06152E-11, 5.40392E-11, 4.78437E-11, 4.20283E-11, 3.65923E-11, 3.15352E-11, 2.68563E-11, 2.25551E-11, 2.05405E-11, 1.86212E-11, 1.86116E-11, 1.86019E-11, 1.3433E-11, 9.10553E-12, 9.10082E-12, 9.09612E-12, 6.67941E-12, 4.63609E-12, 3.75329E-12, 2.96404E-12, 2.96251E-12, 2.96098E-12, 2.26583E-12, 1.66384E-12, 1.15485E-12, 7.38721E-13, 4.15317E-13, 1.8449E-13, 4.60989E-14, 0, 0, 0, 0, 0]
    #Warraytt = Warraytt[0:3:len(Warraytt)]

    f = open('stuffyear.txt', 'w')
    f.write(str(larray))
    f.close()

    #Warraytt = []
    Warrayi = []
    Warrayj = []

    if i > shearBins - 1 or j > shearBins - 1 or i < 0 or j < 0:

	print "i or j (bin number) is greater than the number of Shear bins: ", shearBins
	return

    shearbinarray = linspace(0, max(sortedF2Redshifts), shearBins+1)

    if shearBins == 1:
	zttiarray = F2redshifts

    	organizedListi, numberedListi = lc.organizeRedshifts(zttiarray)
	sortedF2Redshiftsi = lc.sort_Redshift_Values(organizedListi)

    else:
	zttiarray = []
	zttjarray = []

	for ztt in F2redshifts:
		if ztt >= shearbinarray[i] and ztt < shearbinarray[i+1]:
			zttiarray.append(ztt)

		if ztt >= shearbinarray[j] and ztt < shearbinarray[j+1]:
			zttjarray.append(ztt)

	organizedListi, numberedListi = lc.organizeRedshifts(zttiarray)
	sortedF2Redshiftsi = lc.sort_Redshift_Values(organizedListi)
	
	organizedListj, numberedListj = lc.organizeRedshifts(zttjarray)
	sortedF2Redshiftsj = lc.sort_Redshift_Values(organizedListj)


    k = 0
    if shearBins == 1:
	for z in sortedF2Redshifts[1:len(sortedF2Redshifts) - 2]:
		g = open('lists.txt', 'a')
		g.write('orgListi: ' + str(organizedListi[k]) + '\t' + 'numListi: ' + str(numberedListi[k]) + '\n')
    		g.close()
		k += 1
    else:
	for z in sortedF2Redshifts[1:len(sortedF2Redshifts) - 1]:
		g = open('lists.txt', 'a')
		g.write('orgListi: ' + str(organizedListi[k]) + '\t' + 'orgListj: ' + str(organizedListj[k]) + '\t' + 'numListi: ' + str(numberedListi[k]) + '\t' +  'numListj: ' + str(numberedListj[k]) + '\n')
		k += 1
	    	g.close()

    Wvali = 0
    tempWvali = 0
    Wvalj = 0
    tempWvalj = 0

    """
    for z in sortedF2Redshifts[1:len(sortedF2Redshifts) - 1]:

    	print "Determining lensing weight function at z: ", z

	if shearBins == 1:

    		lc = lensingClassFile.lensingClass(0)
		Wvali, tempWvali = lc.lensingWeightFunction(z, sortedF2Redshiftsi, organizedListi, numberedListi)
		Warraytt.append(Wvali)	

	else:
	
		lc = lensingClassFile.lensingClass(0)
		Wvali, tempWvali = lc.lensingWeightFunction(z, sortedF2Redshiftsi, organizedListi, numberedListi)
		lc = lensingClassFile.lensingClass(0)
		Wvalj, tempWvalj = lc.lensingWeightFunction(z, sortedF2Redshiftsj, organizedListj, numberedListj)

		Warrayi.append(Wvali)
		Warrayj.append(Wvalj)
    """

    k = 0

    for z in sortedF2Redshifts[1:len(sortedF2Redshifts) - 1]:
        f = open('shearW.txt', 'a')
	if shearBins == 1:
		f.write('n: ' + str(numberedListi) + '\t' + 'W: ' + str(Warraytt[k]) + '\n')
	else:
		f.write('n_i: ' + str(numberedListi[k]) + '\t' + 'n_j: ' + str(numberedListj[k]) + '\t' + 'W_i: ' + str(Warrayi[k]) + '\t' + 'W_j: ' + str(Warrayj[k]) + '\n')
	f.close()
	k += 1


    for l in larray:

	pKij_l = 0
	ii = 0

    	for z in sortedF2Redshifts[1:len(sortedF2Redshifts) - 1]:

#       		print "Determining cross-spectra weight function at z: ", z

		cosmoCalcs = cosmocalcs.cosmologyCalculator(lc.h, lc.omegams[0], lc.omegams[1], lc.wX, lc.wXa)

		cosmoCalcs.setEmissionRedShift(z)

		D_A = (1 + z) * cosmoCalcs.AngularDiameterDistance()
		D_AMpc = (1 + z) * cosmoCalcs.AngularDiameterDistanceMpc()

		tf = powerspec.transferFunction(lc.omegams[0]-0.05, lc.omegams[2], lc.h)

    		gro = powerspec.growthFunctionLCDM(lc.omegams[0], lc.omegams[1])

    		ps = powerspec.powerSpectrum(tf, gro, ns, DelRsq)

		Pk = ps.getPk(l/D_AMpc, z) # in (Mpc/h)^3 units

		if shearBins == 1:
			pKij_l += Warraytt[ii]*Warraytt[ii]*Pk/(D_AMpc*D_AMpc*100*lc.h*pow(lc.omegams[0]*pow(1 + z, 3) + (1 - lc.omegams[1] - lc.omegams[2])*pow(1 + z, 2) + lc.omegams[2], 0.5))*(sortedF2Redshifts[1] - sortedF2Redshifts[0])
		else:
			pKij_l += Warrayi[ii]*Warrayj[ii]*Pk/(D_AMpc*D_AMpc*100*lc.h*pow(lc.omegams[0]*pow(1 + z, 3) + (1 - lc.omegams[1] - lc.omegams[2])*pow(1 + z, 2) + lc.omegams[2], 0.5))*(sortedF2Redshifts[1] - sortedF2Redshifts[0])

		ii += 1

	pKij.append(pKij_l)
	
        f = open('Pk.txt', 'a')
	fg = open('l.txt', 'a')
	#f.write('pKif_l: ' + str(pKij_l) + '\t' + 'l: ' + str(l) + '\t' + 'l(l+1): ' + str(l*(l + 1)) + '\n')
	f.write(str(pKij_l) + '\n')
	fg.write(str(l) + '\n')
	f.close()
	fg.close()


    pKij_l_1 = []
    pKij_l_1_1bins = []
    i = 0

    for lt in larray:
	pKij_l_1.append(lt*(lt + 1)*pKij[i])
	pKij_l_1_1bins.append(lt*(lt + 1)*pKij[i]/(2.0*math.pi))
	i += 1

    plt.plot(larray, pKij, 'r-')
    #plt.xscale('symlog')
    #plt.yscale('symlog')
    plt.semilogy()
    plt.semilogx()
    plt.xlabel('l')
    plt.ylabel('$P_K^{' + str(i) + str(j) + '}$')
    plt.title('Shear Power Spectrum (' + str(shearBins) + ' bins) vs. Multipole Number')
    plt.axis([min(larray), max(larray), min(pKij), max(pKij)])
    plt.grid(True)
    plt.savefig('pKij_l.png')
    plt.close()

    plt.plot(larray, pKij_l_1, 'r-')
    #plt.xscale('symlog')
    #plt.yscale('symlog')
    plt.semilogy()
    plt.semilogx()
    plt.xlabel('l (multipole number)')
    plt.ylabel('$l(l + 1)/2\pi P_K^{' + str(i) + str(j) + '}$')
    plt.title('Shear Power Spectrum (' + str(shearBins) + ' bins) vs. Multipole Number')
    plt.axis([min(larray), max(larray), min(pKij_l_1), max(pKij_l_1)])
    plt.grid(True)
    plt.savefig('pKij_l_1.png')
    plt.close()


if __name__ == "__main__":
    main(sys.argv[1:])
    
